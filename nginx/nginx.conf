# 以非 root 身分執行 worker
# 備註：master 仍會以 root 啟動以綁定低埠，之後降權給 worker
user  nginx;
worker_processes  auto;             # 自動依 CPU 調整

events { worker_connections 1024; }

http {
  # 速率限制設定
  limit_req_zone $binary_remote_addr zone=api:10m rate=30r/m;
  limit_req_zone $binary_remote_addr zone=general:10m rate=60r/m;
  # 發文相關 API 更嚴格限流（每 IP）
  limit_req_zone $binary_remote_addr zone=posts:10m rate=12r/m;
  
  upstream forumkit_backend {
    server backend:80;
  }

  include       mime.types;         # 使用官方 mime types
  default_type  application/octet-stream;
  sendfile on;
  keepalive_timeout  65;
  server_tokens off;

  # Gzip 壓縮
  gzip on;
  gzip_types text/plain text/css application/javascript application/json application/manifest+json application/xml+rss application/xml image/svg+xml;
  gzip_min_length 1024;
  gzip_comp_level 5;
  gzip_vary on;

  # 日誌（可視需要關閉 access_log）
  access_log  /var/log/nginx/access.log;
  error_log   /var/log/nginx/error.log warn;

  server {
    listen 80;
    server_name _;

    # 靜態 SPA 根目錄（Vite build -> dist 已 COPY 進 /usr/share/nginx/html）
    root /usr/share/nginx/html;
    index index.html;

    # 強化安全標頭
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options DENY always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;
    # CSP（可依實際前端資源調整，暫允許 Google Fonts）
    # 放寬圖片/媒體來源以支援 CDN 圖片預覽（例如模板預覽輸出到 CDN）
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; style-src-elem 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: blob: https:; media-src 'self' blob: https:; connect-src 'self' ws: wss: https:; object-src 'none'; base-uri 'none'; frame-ancestors 'none'" always;
    # 移除 Permissions-Policy 以避免瀏覽器對未支援 feature（如 browsing-topics）的警告
    add_header Permissions-Policy "" always;

    # 上傳檔案
    location /uploads/ {
      root /var/www;  # /var/www/uploads
      add_header X-Content-Type-Options nosniff;
      add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # 發文相關 API（更嚴格的限流）
    location ^~ /api/posts/ {
      limit_req zone=posts burst=8 nodelay;

      proxy_pass http://forumkit_backend;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_read_timeout 300s;
      proxy_connect_timeout 30s;
      client_max_body_size 50m;

      proxy_hide_header X-Powered-By;
      proxy_hide_header Server;
      add_header Access-Control-Expose-Headers "X-ForumKit-Ticket, X-Request-ID, X-ForumKit-Build" always;
      if ($request_method = OPTIONS) { return 204; }
    }

    # 其他 API（一般限流）
    location /api/ {
      # 套用 API 速率限制
      limit_req zone=api burst=10 nodelay;
      
      proxy_pass http://forumkit_backend;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_read_timeout 300s;
      proxy_connect_timeout 30s;
      client_max_body_size 50m;
      
      # 隱藏後端版本資訊
      proxy_hide_header X-Powered-By;
      proxy_hide_header Server;

      # 暴露自訂標頭給瀏覽器
      add_header Access-Control-Expose-Headers "X-ForumKit-Ticket, X-Request-ID, X-ForumKit-Build" always;

      # CORS 由後端處理，移除 Nginx 層的通用 CORS
      if ($request_method = OPTIONS) { return 204; }
    }

    # WebSocket / Socket.IO
    location /socket.io/ {
      proxy_pass http://forumkit_backend;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_read_timeout 600s;
      proxy_send_timeout 600s;
      proxy_connect_timeout 60s;
      proxy_buffering off;
      
      # WebSocket 特定設定
      proxy_cache_bypass $http_upgrade;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;
    }

    # SPA 路由（含速率限制）
    location / {
      # 套用一般速率限制
      limit_req zone=general burst=20 nodelay;
      
      try_files $uri $uri/ /index.html;
      
      # 靜態檔案快取
      location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options nosniff always;
      }
    }
  }
}
