## Host-level Nginx (edge) in front of docker-compose
## Purpose: terminate (or pass-through) and proxy to container Nginx at 127.0.0.1:12005

map $http_upgrade $connection_upgrade { default upgrade; '' close; }

upstream forumkit_container {
  server 127.0.0.1:12005;  # docker-compose nginx -> container :80 mapped to host :12005
}

server {
  listen 80;
  server_name forum.serelix.xyz;

  # If you manage TLS on Cloudflare (Flexible), this block is enough.
  # If Cloudflare SSL mode is Full/Full(strict), add the 443 server below with certs.

  # Pass everything to the container nginx
  location / {
    proxy_pass http://forumkit_container;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
  }
}

# If Cloudflare SSL mode is Full (recommended) or Full (strict), enable this block
# and install a certificate (Let's Encrypt or Cloudflare Origin Certificate).
#
# server {
#   listen 443 ssl http2;
#   server_name forum.serelix.xyz;
#
#   ssl_certificate     /etc/ssl/certs/forum.serelix.xyz.crt;   # adjust
#   ssl_certificate_key /etc/ssl/private/forum.serelix.xyz.key; # adjust
#
#   location / {
#     proxy_pass http://forumkit_container;
#     proxy_http_version 1.1;
#     proxy_set_header Host $host;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header Upgrade $http_upgrade;
#     proxy_set_header Connection $connection_upgrade;
#     proxy_read_timeout 300s;
#     proxy_send_timeout 300s;
#   }
# }

