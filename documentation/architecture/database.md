# ForumKit å¤šè³‡æ–™åº«æ¶æ§‹è¨­è¨ˆ

## æ¦‚è¿°

ForumKit v1.4.0 å¼•å…¥äº†å…¨æ–°çš„å¤šè³‡æ–™åº«æ¶æ§‹ï¼Œå°‡ä¸åŒåŠŸèƒ½æ¨¡çµ„çš„è³‡æ–™åˆ†é›¢åˆ°ç¨ç«‹çš„è³‡æ–™åº«æª”æ¡ˆä¸­ï¼Œæé«˜ç³»çµ±ç©©å®šæ€§å’Œç¶­è­·æ€§ã€‚

## è¨­è¨ˆç†å¿µ

### ğŸ¯ æ ¸å¿ƒç›®æ¨™
- **æœå‹™éš”é›¢**: ä¸åŒåŠŸèƒ½æ¨¡çµ„ä½¿ç”¨ç¨ç«‹è³‡æ–™åº«ï¼Œæ•…éšœä¸æœƒç›¸äº’å½±éŸ¿
- **å‚™ä»½éˆæ´»**: å¯é‡å°ä¸åŒæœå‹™é€²è¡Œç¨ç«‹å‚™ä»½å’Œæ¢å¾©
- **æ“´å±•æ€§å¼·**: æœªä¾†å¯è¼•é¬†å°‡ä¸åŒæœå‹™éƒ¨ç½²åˆ°ä¸åŒä¼ºæœå™¨
- **ç¶­è­·ç°¡å–®**: å•é¡Œå®šä½æ›´ç²¾ç¢ºï¼Œç¶­è­·æˆæœ¬é™ä½

### ğŸ“Š è³‡æ–™åº«åˆ†é›¢ç­–ç•¥

#### 1. **Core Database** (`forumkit_core.db`)
**æ ¸å¿ƒè«–å£‡åŠŸèƒ½**
- `users` - ç”¨æˆ¶è³‡æ–™
- `posts` - è²¼æ–‡å…§å®¹  
- `delete_requests` - åˆªæ–‡ç”³è«‹
- `comments` - ç•™è¨€è³‡æ–™
- `post_reactions` - è²¼æ–‡åæ‡‰
- `comment_reactions` - ç•™è¨€åæ‡‰
- `media` - åª’é«”æª”æ¡ˆ
- `user_roles` - ç”¨æˆ¶è§’è‰²

#### 2. **Support Database** (`forumkit_support.db`)
**å®¢æœæ”¯æ´ç³»çµ±**
- `support_tickets` - æ”¯æ´ç³»çµ±
- `support_messages` - å®¢æœè¨Šæ¯

#### 3. **Chat Database** (`forumkit_chat.db`)
**èŠå¤©å®¤ç³»çµ±**
- `chat_messages` - èŠå¤©è¨Šæ¯
- `chat_rooms` - èŠå¤©å®¤
- `chat_room_members` - èŠå¤©å®¤æˆå“¡

#### 4. **Moderation Database** (`forumkit_moderation.db`)
**å¯©æ ¸å’Œç®¡ç†ç³»çµ±**
- `moderation_logs` - å¯©æ ¸è¨˜éŒ„
- `system_events` - ç³»çµ±äº‹ä»¶
- `notification_preferences` - é€šçŸ¥åå¥½

#### 5. **Organization Database** (`forumkit_organization.db`)
**çµ„ç¹”ç®¡ç†ç³»çµ±**
- `schools` - å­¸æ ¡è³‡æ–™
- `school_settings` - å­¸æ ¡è¨­å®š
- `announcements` - å…¬å‘Š
- `announcement_reads` - å…¬å‘Šé–±è®€è¨˜éŒ„

## æŠ€è¡“å¯¦ç¾

### ğŸ”§ è³‡æ–™åº«ç®¡ç†å™¨

```python
from utils.db_multi import (
    get_core_session,
    get_support_session,
    get_chat_session,
    get_moderation_session,
    get_organization_session
)

# ä½¿ç”¨ä¸åŒçš„è³‡æ–™åº«æœƒè©±
core_db = get_core_session()
support_db = get_support_session()
```

### ğŸ› ï¸ CLI ç®¡ç†å·¥å…·

ForumKit æä¾›äº†å®Œæ•´çš„å‘½ä»¤è¡Œç®¡ç†å·¥å…·ï¼š

```bash
# æŸ¥çœ‹è³‡æ–™åº«ç‹€æ…‹
python scripts/db_manager.py status

# åˆå§‹åŒ–æ‰€æœ‰è³‡æ–™åº«
python scripts/db_manager.py init

# å‚™ä»½æ‰€æœ‰è³‡æ–™åº«
python scripts/db_manager.py backup

# å‚™ä»½æŒ‡å®šæœå‹™
python scripts/db_manager.py backup --service core

# å¾èˆŠè³‡æ–™åº«é·ç§»
python scripts/db_manager.py migrate old_database.db

# æ¸…ç†èˆŠå‚™ä»½
python scripts/db_manager.py cleanup --days 30
```

### ğŸ“¦ è‡ªå‹•é·ç§»

ç³»çµ±æä¾›è‡ªå‹•é·ç§»å·¥å…·ï¼Œå°‡èˆŠçš„å–®ä¸€è³‡æ–™åº«è½‰æ›ç‚ºå¤šæª”æ ¼å¼ï¼š

```bash
python scripts/migrate_to_multi_db.py [åŸå§‹è³‡æ–™åº«è·¯å¾‘]
```

é·ç§»å·¥å…·æœƒï¼š
1. è‡ªå‹•åµæ¸¬åŸå§‹è³‡æ–™åº«
2. åˆå§‹åŒ–æ–°çš„å¤šè³‡æ–™åº«æ¶æ§‹  
3. æŒ‰è¡¨æ ¼åˆ†é¡é·ç§»è³‡æ–™
4. ç”Ÿæˆè©³ç´°çš„é·ç§»å ±å‘Š

## é…ç½®ç®¡ç†

### ğŸ” é€£æ¥è¨­å®š

æ¯å€‹è³‡æ–™åº«éƒ½ä½¿ç”¨å„ªåŒ–çš„ SQLite è¨­å®šï¼š

```python
# é€£æ¥åƒæ•¸
connect_args = {
    "check_same_thread": False,
    "timeout": 30,
    "isolation_level": None
}

# SQLite å„ªåŒ–
PRAGMA journal_mode=WAL
PRAGMA synchronous=NORMAL  
PRAGMA cache_size=10000
PRAGMA temp_store=MEMORY
```

### ğŸ“‚ æª”æ¡ˆçµæ§‹

```
data/
â”œâ”€â”€ forumkit_core.db           # æ ¸å¿ƒåŠŸèƒ½
â”œâ”€â”€ forumkit_support.db        # æ”¯æ´ç³»çµ±
â”œâ”€â”€ forumkit_chat.db           # èŠå¤©å®¤
â”œâ”€â”€ forumkit_moderation.db     # å¯©æ ¸ç®¡ç†
â”œâ”€â”€ forumkit_organization.db   # çµ„ç¹”ç®¡ç†
â”œâ”€â”€ database_info.md           # è³‡æ–™åº«èªªæ˜
â””â”€â”€ migration_report.md        # é·ç§»å ±å‘Š
```

## å‚™ä»½ç­–ç•¥

### ğŸ”„ è‡ªå‹•å‚™ä»½

```python
# å‚™ä»½æ‰€æœ‰è³‡æ–™åº«
backup_paths = backup_all_databases()

# å‚™ä»½æŒ‡å®šæœå‹™
backup_path = db_service.backup_database('core', './backups')

# æ¸…ç†èˆŠå‚™ä»½ï¼ˆä¿ç•™30å¤©ï¼‰
db_service.cleanup_old_backups('./backups', keep_days=30)
```

### ğŸ“‹ å‚™ä»½æª”æ¡ˆå‘½å

æ ¼å¼ï¼š`{æœå‹™å}_{æ™‚é–“æˆ³}.db`
- `core_20250902_143022.db`
- `support_20250902_143022.db`
- `chat_20250902_143022.db`

## ç›£æ§å’Œç¶­è­·

### ğŸ¥ å¥åº·æª¢æŸ¥

```python
# æª¢æŸ¥æ‰€æœ‰è³‡æ–™åº«å¥åº·ç‹€æ…‹
health_status = db_service.get_database_status()

for service, info in health_status.items():
    print(f"{service}: {'âœ…' if info['health'] else 'âŒ'}")
    print(f"  Size: {info['size_mb']} MB")
    print(f"  Tables: {len(info['tables'])}")
```

### ğŸ“Š ç‹€æ…‹ç›£æ§

- **æª”æ¡ˆå¤§å°è¿½è¹¤**: ç›£æ§å„è³‡æ–™åº«æˆé•·è¶¨å‹¢
- **é€£æ¥å¥åº·æª¢æŸ¥**: å®šæœŸé©—è­‰è³‡æ–™åº«é€£æ¥
- **å‚™ä»½ç‹€æ…‹**: è¿½è¹¤å‚™ä»½æˆåŠŸç‡å’Œé »ç‡
- **æ•ˆèƒ½æŒ‡æ¨™**: æŸ¥è©¢å›æ‡‰æ™‚é–“çµ±è¨ˆ

## æœ€ä½³å¯¦è¸

### âœ… å»ºè­°åšæ³•

1. **å®šæœŸå‚™ä»½**: å»ºè­°æ¯æ—¥è‡ªå‹•å‚™ä»½é‡è¦è³‡æ–™åº«
2. **ç›£æ§å¤§å°**: é—œæ³¨è³‡æ–™åº«æª”æ¡ˆå¤§å°æˆé•·è¶¨å‹¢
3. **åˆ†é›¢éƒ¨ç½²**: å¯è€ƒæ…®å°‡ä¸åŒæœå‹™éƒ¨ç½²åˆ°ä¸åŒä¼ºæœå™¨
4. **æ¸¬è©¦æ¢å¾©**: å®šæœŸæ¸¬è©¦å‚™ä»½æª”æ¡ˆçš„æ¢å¾©æµç¨‹

### âš ï¸ æ³¨æ„äº‹é …

1. **è·¨è³‡æ–™åº«æŸ¥è©¢**: é¿å…è·¨è³‡æ–™åº«çš„è¤‡é›œ JOIN æŸ¥è©¢
2. **äº‹å‹™è™•ç†**: è·¨è³‡æ–™åº«çš„åˆ†æ•£å¼äº‹å‹™éœ€è¦ç‰¹åˆ¥è™•ç†
3. **å¤–éµç´„æŸ**: è·¨è³‡æ–™åº«çš„å¤–éµé—œè¯éœ€è¦åœ¨æ‡‰ç”¨å±¤è™•ç†
4. **è³‡æ–™ä¸€è‡´æ€§**: ç¢ºä¿ç›¸é—œè³‡æ–™çš„ä¸€è‡´æ€§ç¶­è­·

## å‡ç´šæŒ‡å—

### ğŸ“ˆ å¾å–®ä¸€è³‡æ–™åº«å‡ç´š

1. **å‚™ä»½åŸå§‹è³‡æ–™**: å‹™å¿…å…ˆå‚™ä»½ç¾æœ‰è³‡æ–™åº«
2. **åŸ·è¡Œé·ç§»å·¥å…·**: ä½¿ç”¨è‡ªå‹•é·ç§»è…³æœ¬
3. **é©—è­‰è³‡æ–™å®Œæ•´æ€§**: æª¢æŸ¥é·ç§»å¾Œçš„è³‡æ–™
4. **æ›´æ–°æ‡‰ç”¨é…ç½®**: ä¿®æ”¹è³‡æ–™åº«é€£æ¥è¨­å®š
5. **æ¸¬è©¦åŠŸèƒ½**: å…¨é¢æ¸¬è©¦å„é …åŠŸèƒ½

### ğŸ”„ ç‰ˆæœ¬å…¼å®¹æ€§

- **v1.3.x**: éœ€è¦åŸ·è¡Œå®Œæ•´é·ç§»
- **v1.4.0+**: åŸç”Ÿæ”¯æŒå¤šè³‡æ–™åº«æ¶æ§‹
- **æœªä¾†ç‰ˆæœ¬**: å‘ä¸‹å…¼å®¹ä¿è­‰

## æ•…éšœæ’é™¤

### ğŸš¨ å¸¸è¦‹å•é¡Œ

#### Q: é·ç§»éç¨‹ä¸­æ–·æ€éº¼è¾¦ï¼Ÿ
A: é‡æ–°åŸ·è¡Œé·ç§»è…³æœ¬ï¼Œç³»çµ±æœƒè‡ªå‹•è·³éå·²å®Œæˆçš„éƒ¨åˆ†ã€‚

#### Q: æŸå€‹è³‡æ–™åº«æå£å¦‚ä½•è™•ç†ï¼Ÿ
A: ä½¿ç”¨å°æ‡‰çš„å‚™ä»½æª”æ¡ˆé€²è¡Œæ¢å¾©ï¼Œå…¶ä»–è³‡æ–™åº«ä¸å—å½±éŸ¿ã€‚

#### Q: å¦‚ä½•ç›£æ§è³‡æ–™åº«æ•ˆèƒ½ï¼Ÿ
A: ä½¿ç”¨å…§å»ºçš„ CLI å·¥å…·æŸ¥çœ‹è³‡æ–™åº«ç‹€æ…‹å’Œçµ±è¨ˆè³‡è¨Šã€‚

---

**æœ€å¾Œæ›´æ–°**: 2025-09-02  
**ç›¸é—œç‰ˆæœ¬**: v1.4.0+