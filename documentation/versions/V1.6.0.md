# ForumKit V1.6.0 - Instagram 模板前置設定作業

## 版本概述

ForumKit V1.6.0 專注於 Instagram 內容發布系統的核心基礎設施建設，主要完善了模板系統的前置設定作業。本版本重新設計了字體載入機制，建立了完整的 HTML 轉圖片引擎，並優化了模板系統的穩定性，為未來的高品質 Instagram 內容自動化發布奠定技術基礎。

## 主要功能

### 1. Google Fonts 整合系統

#### 1.1 動態字體載入機制
- **直接 Google Fonts 整合**：不再依賴本地字體檔案，直接從 Google Fonts API 載入
- **字體載入優先順序**：遠端字體 URL → 自動 Google Fonts → 本地字體 → 系統字體
- **多語系字體支援**：Noto Sans TC（繁體中文）、Roboto（英文）、Huninn（特殊字體）
- **字體快取系統**：記憶體快取機制，避免重複下載提升效能

#### 1.2 安全性控制機制
- **主機白名單限制**：僅允許 `fonts.googleapis.com`、`fonts.gstatic.com` 等信任域名
- **檔案大小限制**：預設限制 5MB，防止惡意大檔案攻擊
- **HTTPS 強制驗證**：拒絕非安全連線的字體請求
- **嚴格主機檢查模式**：可啟用嚴格模式拒絕非白名單請求

### 2. HTML 轉圖片引擎

#### 2.1 模板化 HTML 建構器
- **JSON 模板配置**：完整的模板配置系統，支援畫布、背景、內容區塊設定
- **響應式畫布支援**：square (1080×1080)、portrait (1080×1350)、landscape (1080×608) 預設尺寸
- **環境變數控制**：透過 `IG_CANVAS_SIZE` 動態調整畫布尺寸
- **CSS 自動生成**：根據模板配置自動生成對應 CSS 樣式

#### 2.2 多區塊內容系統
- **內容區塊支援**：content_block、title_block、timestamp、logo 等多種區塊
- **精確位置控制**：支援相對位置（0.0-1.0）和絕對像素位置
- **字體族群映射**：chinese → Noto Sans TC、english → Roboto 自動對應
- **樣式靈活配置**：字體大小、顏色、對齊、行數限制等完全可客製

### 3. 圖片生成引擎優化

#### 3.1 ImageGenerator 核心升級
- **模板驅動生成**：完全基於 JSON 模板配置生成圖片
- **四重字體回退機制**：確保在各種環境下都能正確載入字體
- **智慧記憶體管理**：字體和圖片資源快取，定期清理避免記憶體洩漏
- **完善錯誤處理**：詳細錯誤訊息和異常處理，便於除錯定位

#### 3.2 中文字體渲染優化
- **中文亂碼解決**：完美支援繁體中文正確顯示
- **文字排版增強**：自動換行、行高調整、文字對齊功能
- **圖片品質控制**：支援 JPEG 品質調整，平衡檔案大小與視覺效果
- **背景系統建立**：支援純色背景，為後續漸層和圖片背景預留接口

### 4. 完整測試驗證系統

#### 4.1 多層次測試覆蓋
- **字體系統測試**：`final_font_test.py`、`test_google_fonts.py` 等專項測試
- **圖片生成測試**：`test_html_to_image.py` 完整流程驗證
- **系統整合測試**：跨模組協作功能驗證
- **視覺效果驗證**：自動生成測試圖片供人工檢查

#### 4.2 環境相容性保證
- **跨平台支援**：Windows、Linux、macOS 環境測試
- **依賴版本檢查**：PIL/Pillow、requests 等關鍵套件相容性
- **字體回退測試**：各種字體載入失敗情境處理
- **效能壓力測試**：大量圖片生成的記憶體使用監控

## 技術實現

### 1. 字體載入架構

#### 1.1 載入優先順序設計
```python
# 1. 指定遠端字體 URL
font_url = template_config.get('font_url')

# 2. 自動 Google Fonts URL  
google_fonts_mapping = {
    'chinese': 'Noto+Sans+TC:wght@400',
    'english': 'Roboto:wght@400',
    'huninn': 'Special+Font'
}

# 3. 本地字體檔案
local_fonts = {
    "chinese": "assets/fonts/NotoSansTC-Regular.otf",
    "english": "assets/fonts/Roboto-Regular.ttf"
}

# 4. 系統預設字體（PIL 預設）
```

#### 1.2 安全控制實現
```python
# 環境變數配置
FONT_ALLOWED_HOSTS = "fonts.gstatic.com,fonts.googleapis.com"
FONT_MAX_BYTES = 5242880  # 5MB
STRICT_FONT_HOSTS = 1

# URL 安全驗證
def validate_font_url(url):
    parsed = urlparse(url)
    return parsed.scheme == 'https' and parsed.hostname in allowed_hosts
```

### 2. HTML 建構系統

#### 2.1 模板配置結構
```json
{
  "canvas": {"preset": "square"},
  "background": {"type": "color", "color": "#FFFFFF"},
  "content_block": {
    "font_family": "chinese",
    "font_size": 32,
    "color": "#000000",
    "position": {"x": 0.1, "y": 0.1, "width": 0.8, "height": 0.8}
  },
  "timestamp": {"enabled": true, "position": {"x": 0.9, "y": 0.95}},
  "logo": {"enabled": true, "size": 64}
}
```

#### 2.2 HTML 生成流程
```python
def build_html(template_config, post_content):
    # 1. 解析畫布尺寸
    width, height = _canvas_size(template_config)
    
    # 2. 生成背景 CSS
    bg_css = _bg_css(template_config)
    
    # 3. 收集字體連結
    font_links = _font_links(template_config)
    
    # 4. 建構各區塊 HTML
    content_html = _content_block_html(template_config, post_content)
    
    # 5. 組合完整 HTML
    return complete_html_template
```

### 3. 圖片生成管線

#### 3.1 生成步驟
```python
def generate_post_image(template_config, post_content, school_logo_path):
    canvas = self._create_canvas(template_config)
    canvas = self._apply_background(canvas, template_config['background'])
    canvas = self._render_content_block(canvas, template_config['content_block'], post_content)
    canvas = self._render_timestamp(canvas, template_config['timestamp'], post_content)
    canvas = self._place_logo(canvas, template_config['logo'], school_logo_path)
    return self._save_to_buffer(canvas, format='JPEG', quality=90)
```

#### 3.2 記憶體管理
```python
class ImageGenerator:
    def __init__(self):
        self.font_cache = {}    # 字體快取
        self.temp_files = []    # 臨時檔案追蹤
    
    def cleanup(self):
        # 清理臨時資源和快取
```

## 環境變數配置

### 1. 字體系統設定
```bash
# 字體安全控制
FONT_ALLOWED_HOSTS=fonts.gstatic.com,fonts.googleapis.com,cdn.jsdelivr.net
FONT_MAX_BYTES=5242880
STRICT_FONT_HOSTS=1

# 畫布配置
IG_CANVAS_SIZE=1080x1080
```

### 2. 圖片品質設定
```bash
# 輸出品質控制  
IG_IMAGE_QUALITY=90
IG_IMAGE_FORMAT=JPEG
IG_ASSETS_PATH=/path/to/assets
```

## 測試驗證

### 1. 字體系統測試
```bash
# 基本字體測試
cd backend
python final_font_test.py

# Google Fonts 整合測試
python test_google_fonts.py

# 預期輸出：字體載入成功，生成測試圖片
```

### 2. 圖片生成測試
```bash
# 完整系統測試
python test_html_to_image.py

# 檢查生成檔案
ls -la test_image_generator.jpg
ls -la final_font_test_generated.jpg
```

### 3. 視覺驗證檢查點
- 中文字體無亂碼，字型清晰
- 英文字型與中文協調
- 版面配置正確無重疊
- 圖片品質和檔案大小合理

## 故障排除

### 1. 字體載入問題
```bash
# 檢查 Google Fonts 連線
curl -I "https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400"

# 檢查環境變數
echo $FONT_ALLOWED_HOSTS

# 查看錯誤日誌
tail -f logs/app.log | grep -i font
```

### 2. 圖片生成問題
- 確認模板配置 JSON 格式正確
- 檢查字體族群設定：`font_family: "chinese"`
- 驗證網路連線可存取 Google Fonts
- 監控記憶體使用，定期執行 `cleanup()`

### 3. 效能優化建議
- 降低畫布解析度：調整 `IG_CANVAS_SIZE`
- 使用 CDN 加速字體載入
- 設定合理的快取生命週期
- 監控並限制同時生成圖片數量

## 已知限制

### 1. 功能限制
- 背景僅支援純色，不支援漸層或圖片
- 裝飾元素功能尚未完整實現
- 依賴網路連線載入 Google Fonts

### 2. 效能限制
- 首次載入字體有網路延遲
- 大量同時生成時記憶體消耗較高
- 高解析度圖片生成較耗時

## 未來規劃

### 1. 短期目標
- 支援漸層和圖片背景
- 新增更多裝飾元素
- 優化字體快取策略
- 增加離線字體回退

### 2. 長期目標
- 模板視覺化編輯器
- 批次圖片生成 API  
- AI 輔助模板設計
- 雲端字體服務整合

---

**發布日期**: 2025-09-06  
**版本類型**: 基礎建設和模板系統  
**相容性**: 向下相容（從 V1.5.0 升級）  
**升級難度**: 簡單（主要為功能新增和優化）