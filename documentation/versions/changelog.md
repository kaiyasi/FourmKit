# ForumKit Version Record

> **Serelix Studio 校園匿名討論平台更新日誌**

---

## 版本號規則（Semantic Versioning）

* **主版本號 (Major)**：重大功能或架構變動，可能造成相容性斷裂。
* **次版本號 (Minor)**：新增功能或重要優化，不影響原功能使用。
* **修訂號 (Patch)**：小修正或漏洞補丁，僅影響細節或 bug。

例如 **V1.0.0**：

* `1`：第一次正式公開的大版本
* `0`：目前還沒加入新功能
* `0`：目前還沒修正小 bug

---

## 最新版本（現行：V1.6.1）

### 主要特性

* **完整匿名討論系統**：支援匿名發文、留言、即時互動
* **智慧內容審核**：AI 輔助 + 人工審核雙重把關
* **多校園支援**：Google OAuth 校園帳號驗證，支援跨校討論
* **即時通訊**：Flask-SocketIO 實時更新，Heartbeat 心跳監控
* **媒體安全**：pending/public 兩階段存儲，CDN 整合，副檔名/大小限制
* **主題系統**：多種內建主題 + 自訂主題設計工具（行動版/桌面版一致）
* **Discord 整合**：Webhook / Bot / Both 模式，回報、主題提案、公告、學校入駐通知
* **行動體驗**：統一 MobileBottomNav、安全區域留白、學校切換、觸控優化
* **🎫 企業級支援工單系統**：完整生命週期管理、雙重身份支援、即時通訊整合
* **📱 Mobile-first 支援介面**：三合一行動介面（建立/追蹤/管理）、響應式設計
* **📸 Instagram 模板系統**：Google Fonts 整合、HTML 轉圖片引擎、模板化圖片生成、中文字體優化
* **📦 ForumKit 核心模組**：獨立 forumkit 套件、Socket 通訊核心、管道處理系統、頁面發布器

### 安全性

* **權限管理**：分級權限（開發者、校園管理員、審核員、用戶）
* **企業級防護**：CORS 限制、CSP、HSTS、速率限制、自動封鎖
* **資料保護**：JWT 認證、輸入驗證、SQL 注入防護、內容清洗
* **隱私工具**：使用者亂碼 ID（HMAC），支援複製；個人 webhook 綁定
* **🛡️ 多層防護機制**：蜂蜜罐檢測、垃圾內容過濾、速率限制、相似內容檢測
* **🔐 訪客安全追蹤**：HMAC 簽章驗證、時效性 Token、雙重身份支援

### 管理功能

* **內容審核**：pending → approved/rejected，審核日誌追蹤、批次操作
* **刪文請求審核**：API 查詢/核准/拒絕
* **用戶管理**：帳號、角色、違規處理
* **學校管理**：多校設定、統計分析、校徽上傳
* **系統監控**：健康檢查 `/api/healthz`、整合狀態 `/api/status/integrations`、錯誤追蹤
* **📊 支援工單管理**：多條件搜尋、SLA 警示、批次指派、內部備註、標籤系統
* **📈 統計分析**：解決率追蹤、優先級分布、管理員工作負載、時效性統計
* **📊 Instagram 管理**：帳號管理、發布記錄、統計分析、自動發布檢查

### 技術架構

* **前端**：React 18 + TypeScript + Tailwind CSS
* **後端**：Flask + SQLAlchemy + Socket.IO
* **資料庫**：PostgreSQL + Redis
* **部署**：Docker Compose + Nginx（HTTPS/CDN/健康檢查整合）

### 運維/部署

* 一鍵重建/維護腳本
* Docker Compose 健康檢查與依賴管理
* 外部 Nginx 反代、CDN 配置
* FAQ/排查/安全環境變數文件

---

## 版本歷史

### V1.0.0

* 匿名討論、留言、媒體上傳
* 完整審核流程（pending → approved/rejected）
* 權限分級（admin/moderator/user）
* JWT 認證 + Flask-SocketIO 即時互動
* Google OAuth（僅限 .edu 網域）
* Docker 一鍵部署 + 運維腳本
* API 文件、常見問題、MIT 授權條款

### V1.1.0

* **Discord/IG/Webhook 整合**：事件型別、投遞模式、Redis 佇列
* **前端主題設計器**：支援 webhook 提交
* **刪文請求審核 API**
* **健康檢查與狀態 API**
* **安全性強化**：速率限制封鎖、內容清洗、CSP/HSTS
* **行動體驗優化**：統一 UI、學校切換、MobileBottomNav
* **Webhook 自綁功能**：用戶可綁定個人 webhook，選擇推送類型（新貼文/留言/公告）
* **新增環境變數**：`ADMIN_NOTIFY_DELIVERY`、`USER_WEBHOOK_FEED_INTERVAL`、`PUBLIC_BASE_URL`、`PUBLIC_CDN_URL`、`APP_BUILD_VERSION`

### V1.1.1
*🗓️ 發布日期：2025-08-27*

* **UI 介面改進**
  * Navbar 改為圖標＋文字設計，提升視覺識別度
  * 新增返回按鈕至模式管理頁面
  * 主題切換功能優化，切換更流暢
* **用戶體驗提升**
  * 導航欄圖標化，減少認知負擔
  * 改善頁面間的導航邏輯

### V1.1.2
*🗓️ 發布日期：2025-08-27*

* **即時功能增強**
  * 實現用戶在線狀態追蹤
  * 新增線上/離線狀態顯示
  * 即時訊息同步機制優化
* **用戶體驗**
  * 用戶存在感檢測，提升互動體驗
  * 實時狀態更新，增強社交感

### V1.1.3
*🗓️ 發布日期：2025-08-27*

* **手機版優化**
  * MobileBottomNav 統一化設計
  * SchoolSwitcher 行動版體驗調整
  * 行動版 UI 一致性大幅提升
* **跨平台體驗**
  * 手機與桌面版操作邏輯統一
  * 響應式設計進一步完善

### V1.1.4
*🗓️ 發布日期：2025-08-28*

* **錯誤修復**
  * 修復 React Router 相關穩定性問題
  * 解決部分邊界情況的異常處理
* **性能優化**
  * 減少不必要的重新渲染
  * 優化組件生命週期管理

### V1.1.5
*🗓️ 發布日期：2025-08-28*

* **重大改進**
  * **移除手機臨時頁功能** - 不再顯示「手機版開發中」頁面
  * **直接導向 boards 頁面** - 手機用戶訪問首頁自動重導向至貼文列表
  * **修復 React Error #300** - 解決手機版 minified React 錯誤
* **用戶體驗提升**
  * 手機用戶無需額外點擊，直達核心功能
  * 保留 `?stay` 參數作為測試後門
  * 維護模式功能完整保留
* **技術改進**
  * 使用安全的頁面重導向機制
  * 避免 React Router 在手機端的相容性問題

### V1.1.6
*🗓️ 發布日期：2025-08-28*

* **🎫 全新工單系統**
  * **完整工單生命週期管理** - 從提交到解決的完整追蹤
  * **智慧身份識別碼** - 已登入用戶自動獲得追蹤碼，匿名用戶可用Email追蹤
  * **雙重追蹤機制** - 支援已登入用戶站內查詢 + 未登入用戶追蹤碼查詢
  * **工單號碼系統** - 格式：FK-YYYYMMDD-XXXXXXXX，便於管理和溝通
* **📱 行動優先設計**
  * **MobileSupportPage** - 專為手機優化的三合一介面（提交/追蹤/歷史）
  * **MobileTicketCard** - 響應式工單卡片，支援展開查看回覆詳情
  * **MobileSupportForm** - 觸控友好的工單提交表單
  * **TicketTrackPage** - 桌面版工單追蹤頁面
* **🔐 權限分級處理**
  * **校內/跨校範圍** - 支援校內管理員處理校內工單，跨校管理員處理跨校工單
  * **管理員回覆系統** - 支援公開回覆和內部備註
  * **自動指派機制** - 管理員回覆時自動指派工單
* **📊 完整數據模型**
  * **SupportTicket** - 工單主表，包含狀態、優先級、分類等完整資訊
  * **TicketResponse** - 回覆記錄，支援內部備註和公開回覆
  * **TicketHistory** - 工單異動歷史，完整追蹤每次變更
  * **UserIdentityCode** - 用戶識別碼系統，支援匿名用戶追蹤
* **🛡️ 安全性增強**
  * **速率限制** - 防止工單系統被濫用
  * **權限驗證** - 確保用戶只能查看和操作自己的工單
  * **數據驗證** - 完整的輸入驗證和清理機制

### V1.2.0
*🗓️ 發布日期：2025-08-28*

* **🚀 重大升級：企業級支援工單系統**
  * **完全重新設計的支援系統** - 從簡單回報升級為完整工單管理平台
  * **雙重身份支援** - 登入用戶和訪客皆可建立、追蹤、回覆工單
  * **智慧工單編號** - SUP-XXXXXX 格式，便於識別和管理
  * **完整狀態機** - open → awaiting_user/admin → resolved → closed → reopened
  * **事件審計系統** - 完整追蹤所有工單操作和狀態變更

* **📱 Mobile-first 支援介面**
  * **MobileSupportPage** - 三合一行動介面（建立/追蹤/歷史）
  * **三步驟建立精靈** - 基本資訊 → 詳細描述 → 提交確認
  * **MobileTicketCard** - 響應式工單卡片，支援展開查看回覆
  * **觸控優化體驗** - 專為行動裝置設計的操作流程
  * **離線提示機制** - 網路狀態監控和重試邏輯

* **🔐 進階安全防護系統**
  * **蜂蜜罐檢測** - 隱藏欄位檢測機器人提交
  * **垃圾內容過濾** - 關鍵詞檢測和惡意 URL 識別
  * **智慧速率限制** - 滑動窗口演算法，支援 Redis 儲存
  * **相似內容檢測** - SHA256 雜湊檢測重複提交
  * **HMAC 簽章系統** - 訪客安全追蹤，30天有效期

* **⚡ Socket.IO 即時通訊整合**
  * **即時工單更新** - 新訊息、狀態變更即時推送
  * **打字指示器** - support:typing 事件支援
  * **房間管理機制** - 工單專屬房間 + 管理員群組廣播
  * **離線重連機制** - 自動重連和訊息同步
  * **事件廣播系統** - ticket_created/message_sent/status_changed

* **📧 專業級通知系統**
  * **HTML 郵件模板** - 精美的響應式 Email 設計
  * **多場景通知** - 工單建立/管理員回覆/狀態變更/解決確認
  * **簽章連結** - 訪客免登入安全存取
  * **Email 線程追蹤** - 自動生成追蹤連結和參考編號
  * **通知失敗處理** - 重試機制和錯誤追蹤

* **🎯 管理員專業工具**
  * **進階搜尋篩選** - 多維度工單查詢（狀態/學校/指派人/分類）
  * **批次操作功能** - 標籤管理、狀態批次更新
  * **內部備註系統** - 管理員間協作，用戶不可見
  * **SLA 監控警示** - 超時工單自動提醒
  * **工作負載統計** - 管理員分配和效率追蹤

* **📊 完整統計分析系統**
  * **解決率追蹤** - 即時計算工單解決效率
  * **優先級分布** - 可視化工單重要程度分析
  * **分類統計** - 問題類型趨勢分析
  * **響應時效性** - 首次回覆時間和平均解決時間
  * **管理員績效** - 個人工作負載和處理效率

* **🔧 開發者友善特性**
  * **完整 API 文檔** - 前台/後台 REST API
  * **單元測試覆蓋** - pytest 測試套件，涵蓋核心功能
  * **演示腳本** - demo_support.sh 一鍵展示完整流程
  * **Docker 整合** - 容器化部署，健康檢查機制
  * **結構化日誌** - JSON 格式，便於監控和分析

* **🛠️ 技術架構升級**
  * **新增資料模型** - SupportTicket/Message/Event/Label 完整設計
  * **索引優化** - 查詢性能大幅提升
  * **Redis 快取** - 速率限制和內容檢測快取
  * **Email 服務分離** - 可插拔 SMTP 配置
  * **安全中介軟體** - 統一安全檢查和違規記錄

---

### V1.3.0
*🗓️ 發布日期：2025-08-31*

* **📸 Instagram 整合系統**
  * **自動化內容發布** - 每 10 篇貼文或每 6 小時自動發布到 Instagram
  * **多校帳號管理** - 總平台 IG 帳號和校園 IG 帳號分離管理
  * **模板編輯系統** - 文字、校徽、背景、時間戳、Caption 模板自訂
  * **發布記錄追蹤** - 完整的發布狀態和錯誤記錄
  * **權杖管理** - 加密儲存、自動刷新、到期提醒

* **🎛️ 管理後台改進**
  * **Instagram 管理頁面** - 帳號管理、發布記錄、統計分析、操作工具
  * **刪文請求快捷卡片** - 顯示待審數量和今日處理數量
  * **統計資料改進** - 修正「今日已處理」數字，基於審核紀錄計算
  * **移除聊天室卡片** - 簡化管理後台介面

* **🔔 通知系統重新設計**
  * **智能通知顯示** - 通知數量反映實際未讀數，10 秒後變為紅點
  * **主題系統整合** - 修正 NavBar 通知數字的顏色問題
  * **用戶體驗優化** - 點開或標記已讀後不再顯示數字

* **🔧 技術架構升級**
  * **新增資料模型** - InstagramAccount/Setting/Template/Post/Event
  * **服務層架構** - InstagramService 封裝核心業務邏輯
  * **API 端點** - 前台和管理後台 Instagram API
  * **圖片生成** - PIL 圖片處理，支援模板套用
  * **權限控制** - 角色基礎的 Instagram 管理權限

* **📊 完整文檔和測試**
  * **詳細版本記錄** - V1.3.0 完整功能說明和技術實現
  * **測試腳本** - 管理後台和通知系統測試
  * **API 文檔** - Instagram 整合 API 端點說明
  * **部署指南** - 環境變數、依賴套件、資料庫遷移

---

### V1.3.1
*🗓️ 發布日期：2025-09-01*

* **📢 公告通知系統整合**
  * **WebSocket 即時公告推送** - 新公告發布時即時推送到所有在線用戶
  * **公告通知 Hook** - `useAnnouncementNotifications` 整合到前端通知系統
  * **後端公告事件廣播** - `broadcast_announcement` 函數實現 WebSocket 事件推送
  * **通知中心整合** - 公告通知顯示在統一的通知中心，支援分類和篩選
  * **緊急公告處理** - 高優先級公告特殊標記和額外提示

* **🔧 後端架構改進**
  * **公告通知補丁** - `announcement_notification_integration.py` 實現完整通知流程
  * **WebSocket 事件擴展** - 新增 `announcement` 事件類型
  * **通知服務整合** - 公告發布時自動觸發通知和 WebSocket 廣播
  * **錯誤處理增強** - 完善的異常捕獲和日誌記錄

* **📱 前端通知體驗**
  * **公告通知卡片** - 專用公告通知樣式，包含標題、內容預覽、操作按鈕
  * **通知分類系統** - 公告通知獨立分類，支援按類型篩選
  * **響應式通知中心** - 通知中心在小螢幕設備上的優化顯示
  * **通知持久化** - 使用 localStorage 保存通知狀態

---

### V1.3.2
*🗓️ 發布日期：2025-09-02*

* **📱 通知系統響應式設計優化**
  * **小螢幕適配** - 通知中心面板在小螢幕設備上的位置和尺寸調整
  * **NavBar 重疊修復** - 解決通知面板與導航欄重疊的問題
  * **響應式佈局** - 桌面端和移動端不同的顯示策略
  * **觸控優化** - 移動端按鈕大小和間距優化

* **🎨 UI/UX 改進**
  * **位置調整** - 桌面端 `top-16`，移動端 `top-20` 避免重疊
  * **尺寸優化** - 桌面端固定寬度，移動端全寬減邊距
  * **內容適配** - 標題欄、圖標、文字大小的響應式調整
  * **操作按鈕** - 移動端簡化文字，增加觸摸區域

* **🔧 技術實現**
  * **Tailwind CSS 響應式類** - 使用 `md:` 前綴實現斷點適配
  * **動態尺寸計算** - `calc()` 函數實現精確的尺寸控制
  * **條件渲染** - 根據螢幕尺寸顯示不同的 UI 元素
  * **CSS 變數整合** - 主題系統與響應式設計的完美結合

* **📊 測試和驗證**
  * **響應式測試腳本** - `test_notification_responsive.sh` 驗證修復效果
  * **多設備測試** - 在不同螢幕尺寸下驗證通知中心顯示
  * **用戶體驗驗證** - 確保通知面板不與其他 UI 元素重疊

---

### V1.3.3
*🗓️ 發布日期：2025-09-02*

* **🐛 留言監控 API 錯誤修復**
  * **500 內部伺服器錯誤修復** - 解決留言監控頁面的系統錯誤
  * **跨校查詢邏輯優化** - 修復 NULL 值比較導致的查詢錯誤
  * **學校過濾邏輯改進** - 正確處理 `__ALL__` 參數的過濾邏輯
  * **錯誤處理增強** - 添加詳細的錯誤日誌和堆疊追蹤

* **🔍 查詢邏輯修復**
  * **NULL 值安全比較** - 使用 `isnot(None)` 確保安全的 NULL 值處理
  * **跨校權限查詢** - 修復跨校管理員和跨校審核員的查詢條件
  * **學校過濾參數** - 正確處理 `__ALL__` 表示查看所有學校
  * **權限檢查優化** - 確保不同角色用戶的查詢權限正確

* **🛡️ 錯誤處理改進**
  * **詳細錯誤日誌** - 添加 `traceback.format_exc()` 提供完整錯誤信息
  * **異常捕獲增強** - 完善的 try-catch 機制確保系統穩定性
  * **錯誤診斷工具** - 提供診斷腳本幫助排查問題
  * **用戶友好錯誤** - 返回結構化的錯誤響應

* **📋 管理功能穩定性**
  * **留言監控頁面** - 確保管理員可以正常查看和操作留言
  * **權限系統** - 修復不同角色用戶的權限檢查邏輯
  * **數據查詢** - 優化複雜查詢的性能和穩定性
  * **API 響應** - 確保所有管理 API 返回正確的數據格式

* **🔧 開發工具**
  * **診斷腳本** - `debug_comment_monitor.py` 用於排查留言監控問題
  * **測試腳本** - `test_comment_monitor_fix.py` 驗證修復效果
  * **錯誤追蹤** - 完善的日誌系統便於問題定位和解決

---

### V1.4.0
*🗓️ 發布日期：2025-09-03*

* **🗑️ Instagram 服務移除**
  * **功能清理** - 完全移除 Instagram 相關功能和程式碼
  * **路由清理** - 移除 `routes/routes_cdn.py` 中的 Instagram 預覽路由
  * **工具清理** - 移除 `utils/sanitize.py` 中的 Instagram 特定註解
  * **應用清理** - 清理 `app.py` 中的 Instagram 註解

* **🏗️ 多資料庫架構實施**
  * **服務分離的多資料庫系統** - 核心功能、支援系統、聊天室、審核管理、組織管理
  * **資料庫初始化** - 新增 `init_multi_db.py` 資料庫初始化腳本
  * **遷移腳本** - 新增 `scripts/migrate_to_multi_db.py` 遷移腳本
  * **多資料庫管理** - 新增 `utils/multi_db.py` 和 `utils/db_multi.py` 管理模組

* **📚 文檔結構重整**
  * **目錄重組** - 重新整理 `documentation/` 資料夾結構
  * **分類歸檔** - 分類至 `features/`、`architecture/`、`guides/`、`versions/`
  * **文檔歸檔** - 舊文檔歸檔至 `documentation_archive/`

---

### V1.5.0
*🗓️ 發布日期：2025-09-03*

* **📋 版本記錄系統**
  * **統一版本追蹤機制** - 完整的版本歷史記錄，從 V1.0.0 到 V1.5.0
  * **版本比較功能** - 提供版本間的詳細對比分析
  * **升級指南整合** - 每個版本都有對應的升級指南和注意事項
  * **變更日誌系統** - 結構化的變更記錄，便於追蹤和查詢

* **🛠️ 系統優化**
  * **多資料庫系統穩定性提升** - 連接池優化、錯誤處理增強
  * **性能監控** - 實時監控資料庫性能和健康狀態
  * **自動備份** - 改進的備份策略和恢復機制
  * **系統維護工具** - 健康檢查腳本、維護腳本、監控工具

* **📊 監控改善**
  * **資料庫健康檢查** - 連接狀態監控、性能指標追蹤、自動告警機制
  * **系統狀態監控** - 服務狀態追蹤、資源使用監控、錯誤追蹤改進
  * **健康報告** - 定期生成系統健康狀態報告

### V1.6.1
*🗓️ 發布日期：2025-09-13*

* **📦 ForumKit 核心模組建立**
  * **新增獨立 ForumKit 模組** - 建立 `forumkit/` 套件，提供核心功能抽象層
  * **Socket 通訊核心** - `server.py` 和 `client.py` 實現高效能 Socket 通訊機制
  * **管道處理系統** - `pipeline.py` 提供資料處理管道，支援 Facebook/Instagram 發布流程
  * **頁面發布器** - `page_poster.py` 整合 Facebook Page API，支援自動內容發布

* **🔧 技術架構優化**
  * **模組化重構** - 將核心功能從主應用分離，提升代碼可維護性和重用性
  * **統一錯誤處理** - 完善的異常捕獲和錯誤日誌記錄機制
  * **配置管理改進** - 環境變數統一管理，支援開發和生產環境切換
  * **Socket 連接池** - 高效能的連接管理，支援併發請求處理

* **📱 Mobile Admin 支援系統增強**
  * **工單管理行動化** - MobileAdminSupport 組件全面優化，支援完整工單生命週期管理
  * **響應式管理介面** - 改進的行動端管理體驗，支援觸控操作和手勢導航
  * **即時狀態更新** - 工單狀態、優先級、分類的即時同步和更新
  * **批次操作支援** - 行動端支援工單批次處理和標籤管理

* **📸 Instagram 發布系統穩定性提升**
  * **發布服務改進** - platform_publishers 和 instagram_page_publisher 穩定性增強
  * **內容處理優化** - 圖片處理和模板系統性能提升
  * **錯誤恢復機制** - 發布失敗時的自動重試和錯誤追蹤
  * **監控和日誌** - 詳細的發布狀態記錄和性能監控

* **🧪 測試覆蓋率提升**
  * **Socket 通訊測試** - `test_socket_and_pipeline.py` 完整測試 Socket 功能
  * **整合測試增強** - 端到端測試覆蓋核心業務流程
  * **效能測試** - 併發處理和高負載情況下的系統穩定性測試
  * **自動化測試** - CI/CD 流程整合，確保代碼品質

* **🛡️ 安全性和穩定性**
  * **連接安全** - Socket 通訊加密和身份驗證機制
  * **資源管理** - 記憶體和連接資源的智慧管理，防止洩漏
  * **監控增強** - 系統健康狀態監控和自動告警機制
  * **日誌改進** - 結構化日誌記錄，便於問題追蹤和分析

---

### V1.6.0
*🗓️ 發布日期：2025-09-06*

* **📸 Instagram 模板前置設定作業**
  * **Google Fonts 直接整合** - 動態字體載入，支援 Noto Sans TC、Roboto 等多語系字體
  * **字體安全控制機制** - 主機白名單、檔案大小限制、HTTPS 強制驗證
  * **HTML 轉圖片引擎** - 模板化 HTML 建構器，支援響應式畫布設計
  * **多區塊內容系統** - content_block、timestamp、logo 等靈活配置
  * **中文字體渲染優化** - 完美解決中文亂碼問題，支援繁體中文正確顯示
  * **完整測試驗證系統** - 字體系統測試、圖片生成測試、視覺效果驗證

* **🔧 技術架構改進**
  * **四重字體回退機制** - 遠端字體 → Google Fonts → 本地字體 → 系統字體
  * **智慧記憶體管理** - 字體和圖片資源快取，定期清理避免記憶體洩漏
  * **環境變數控制** - `IG_CANVAS_SIZE`、`FONT_ALLOWED_HOSTS` 等靈活配置
  * **完善錯誤處理** - 詳細錯誤訊息和異常處理，便於除錯定位

* **🎨 模板系統建立**
  * **JSON 模板配置** - 完整的模板配置系統，包含畫布、背景、內容區塊設定
  * **精確位置控制** - 支援相對位置（0.0-1.0）和絕對像素位置混合定位
  * **圖片品質控制** - 支援 JPEG 品質調整，平衡檔案大小與視覺效果
  * **跨平台相容性** - Windows、Linux、macOS 環境測試通過

---

*📅 最後更新：2025-09-06*
*🏢 開發團隊：Serelix Studio*
*📧 技術支援：透過平台內建支援系統*

---