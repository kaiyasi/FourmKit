# ForumKit V2.0.0 - Instagram 自動化內容發布系統

## 版本概述

ForumKit V2.0.0 正式推出了完整的 Instagram 自動化內容發布系統。此版本基於 V1.6.0 建立的強大 HTML 圖片生成引擎，向上建構了一個全自動、事件驅動的發布管道（Pipeline）。系統現在不僅能發布單張圖片，更核心的功能是能夠將多個獨立的社群貼文（SocialPost）聚合成一則輪播（Carousel）貼文進行發布，極大地豐富了內容呈現形式，並實現了從內容創建到社群媒體曝光的無縫整合。

## 主要功能

### 1. 支援輪播（Carousel）與單張圖片發布
- **輪播貼文聚合**：系統的核心機制。能夠自動收集多張獨立生成的貼文圖片，將它們歸入一個「輪播群組」（Carousel Group）。
- **單張圖片即時發布**：對於單獨的、重要的內容，也支援立即生成單張圖片並發布。
- **智慧發布模式**：根據帳號設定的批次大小（batch_size），自動決定是發布輪播還是單張圖片。

### 2. 自動化發布管道 (Publishing Pipeline)
- **事件驅動與排程**：系統會根據預設規則（例如每累積 10 篇新貼文或每隔 6 小時）自動觸發發布流程。
- **佇列系統**：使用 Redis 佇列來管理待處理的發布任務，確保在高負載下系統的穩定性和可靠性。
- **ForumKit 核心整合**：發布流程由 `forumkit/pipeline.py` 核心模組驅動，該模組封裝了發布到 Instagram 的完整流程。

### 3. 多帳號發布管理
- **平台與校園分離**：支援設定一個總平台主要的 Instagram 帳號，以及各個獨立校園自己的 Instagram 帳號。
- **手動權杖配置**：系統依賴管理員手動生成並在環境變數中配置長期有效的頁面存取權杖（Page Access Token）。

### 4. 發布狀態監控與管理
- **管理後台整合**：在管理後台中新增「Instagram 管理」頁面，提供對單一貼文和輪播群組的發布記錄查詢。
- **詳細日誌與修復工具**：每一筆發布任務都有詳細日誌。`fix_carousel_groups.py` 等工具可幫助管理員診斷和修復卡住的輪播群組狀態。

## 技術實現

### 1. 輪播發布流程（Carousel Publishing Flow）
輪播發布是透過 Facebook Graph API 的一個多步驟過程實現的：
1.  **上傳子項目**：系統會並行上傳輪播中的每一張圖片，作為「未發布」的媒體項目，並獲取它們各自的媒體 ID。
2.  **建立容器**：使用獲取到的所有媒體 ID，請求建立一個「輪播容器」（Carousel Container）。
3.  **發布容器**：最後，發布這個容器，使其出現在 Instagram 的動態消息中。這個流程被完整封裝在 `forumkit/pipeline.py` 中。

### 2. 核心模組與資料模型
- **`CarouselGroup` (資料模型)**：用於組織和追蹤輪播貼文的狀態，如 `collecting`, `ready`, `processing`, `completed`。
- **`SocialPost` (資料模型)**：代表一個準備發布到社群媒體的獨立內容，包含生成的圖片 URL 和文字，並可關聯到一個 `CarouselGroup`。
- **`instagram_service.py`**：後端服務層，封裝了如何觸發單張圖片或輪播發布的業務邏輯。
- **`forumkit/pipeline.py`**：執行與 Facebook/Instagram API 互動的底層邏輯，是發布功能的核心。

## 環境變數配置

```bash
# 自動發布觸發條件
IG_AUTO_POST_INTERVAL_HOURS=6
IG_AUTO_POST_THRESHOLD_POSTS=10

# Facebook 應用程式憑證與手動獲取的權杖
FACEBOOK_APP_ID="your_app_id"
FACEBOOK_APP_SECRET="your_app_secret"
FACEBOOK_PAGE_ACCESS_TOKEN="manually_generated_long_lived_token"

# Redis 連接資訊
REDIS_HOST="localhost"
REDIS_PORT=6379
```

## 測試驗證

### 1. 發布功能測試
```bash
# 執行一個完整的端到端發布流程，其中可能包含輪播邏輯
cd backend
python test_ig_posting.py
```

### 2. 輪播狀態修復
```bash
# 當輪播群組卡在 failed 狀態時，可執行此腳本進行修復
cd backend
python fix_carousel_groups.py
```

## 故障排除

### 1. 發布失敗
- **權杖問題**：最常見的問題是權杖過期或權限不足。請到 Facebook 開發者工具中重新生成一個長期權杖，並確保其具有 `pages_show_list`, `pages_read_engagement`, `instagram_basic`, `instagram_content_publish` 權限，然後更新 `FACEBOOK_PAGE_ACCESS_TOKEN` 環境變數。
- **輪播項目限制**：確認輪播中的圖片數量在 2 到 10 張之間。檢查 `instagram_post_logs` 中的 API 錯誤訊息。

### 2. 輪播群組卡住
- 如果一個輪播群組長時間處於 `processing` 或 `failed` 狀態，可以執行 `python fix_carousel_groups.py` 來嘗試自動修復其狀態。

## 已知限制

- **不支援混合媒體**：輪播貼文中不能混合圖片和影片，當前版本僅支援全圖片的輪播。
- **手動權杖維護**：存取權杖需要管理員定期手動更新，系統本身不提供自動刷新功能。

---

*📅 最後更新：2025-09-16*
*🏢 開發團隊：Serelix Studio*
*📧 技術支援：透過平台內建支援系統*

---