# ForumKit V3.0.0 - 行動端支援中心重構與 IG 全面優化

🗓️ 發布日期：2025-10-10


## 版本概述

ForumKit V3.0.0 正式針對行動端支援中心與管理介面做重構，並完成 Instagram 渲染/Caption/發布鏈的全面優化。與 V2.x 相比，V3 採混合式（Mobile-first + 桌機專版）設計以解決純響應式在小螢幕的體驗問題，同時導入聊天室成員治理（邀請/移除/刪除頻道）與更一致的設計語言，並修正若干構建錯誤與瀏覽器警示，整體穩定性顯著提升。

本版聚焦「行動端支援中心與管理介面重構」與「客服聊天室權限化與成員管理」。同時針對手機端多處 UI 疊壓與間距進行優化，並統一後端端點規格，為後續擴充與治理打下基礎。

## 主要功能

- 行動端支援中心重構：Mobile-first + 桌機專版整合、送出後詳情頁體驗改良。
- 客服聊天室治理：邀請/移除成員、刪除頻道，端點規格統一。
- 管理後台（手機）優化：審核管理/留言監控間距與遮擋修正、資訊卡一致化。
- FAQ/關於/規範（手機）內文與標題顯示優化，去冗餘。

## 特色

- 體驗一致：首頁/支援/審核/聊天室在行動端採一致設計語言。
- 權限化治理：聊天室引入成員名單與刪除頻道，管理更可控。
- 穩定提升：修復構建錯誤、瀏覽器警示，WebSocket 重連更穩定。
- 部署友善：Nginx Permissions-Policy 清理與 Socket 反代強化。

## 教學說明

- 依「升級步驟」實作後端端點並重新部署：
  ```bash
  docker compose build backend frontend nginx && docker compose up -d
  ```
- 於後台聊天室測試：邀請/移除成員、刪除頻道，驗證端點正確性。

---

🎯 BREAKING CHANGES
- Instagram 整體優化與修正（詳見下方 IG 專節）。

- 支援中心（行動端）介面結構調整：改為混合式（Mobile-first + 桌機專版），部分 class 與區塊結構變更，舊樣式覆蓋可能失效。
- 客服聊天室（Admin）新增/依賴統一端點規格：
  - GET /api/admin/chat/rooms/{roomId}/members
  - POST /api/admin/chat/rooms/{roomId}/invite { user_ids: number[] }
  - DELETE /api/admin/chat/rooms/{roomId}/members/{userId}
  - DELETE /api/admin/chat/rooms/{roomId}
  若後端未實作上述端點，相關功能將不可用。

---

✨ NEW FEATURES
- 支援中心（行動端）
  - 送出工單後的詳情頁：對話紀錄訊息簡化（預設不再重複顯示提交者與時間，避免冗餘）。
  - 工單卡片資訊：調整「開啟 / 技術問題」等標籤區塊，優先呈現工單資訊；移除單號右側的優先級顯示（以降低干擾）。
  - 導覽一致性：沿用首頁標題與底部 NavBar 設計語言。
- 客服聊天室（/admin/chat）
  - 編輯彈窗加入「邀請成員」：可搜尋、加入/移除待邀請清單，儲存時一次送出。
  - 現有成員列表：支援逐一移除。
  - 刪除頻道：管理角色可直接刪除聊天室。
- 管理後台（行動端）
  - 審核管理與留言監控頁面：上移主內容，修正底部被 NavBar 遮擋；整體間距精簡。
  - 審核日誌（手機）：欄位簡寫「經手 / 來源」，時間僅顯示日期，狀態可獨行顯示。
  - 聊天室頁面新增置頂資訊卡，與審核管理保持一致。
- FAQ / 關於我們 / 社群規範
  - FAQ 移除主/副標模板冗餘。
  - 關於我們、社群規範（手機）避免在 MD 內容前後重複顯示標題文字。

---

🛠️ IMPROVEMENTS
- 手機底部導覽：統一底部安全間距（避免遮擋清單最末項）。
- Nginx：清空 Permissions-Policy，避免瀏覽器顯示未支援 feature（browsing-topics）警示。
- 前端穩定性：
  - 修正多處 JSX 語法與條件渲染括號錯置造成的構建失敗。
  - 移除 onChange 內 inline const v 用法，避免壓縮後暫時性死區導致 "Cannot access 'v' before initialization"。

---

🐛 BUG FIXES
- 修正支援中心相關頁面在行動端的版面跑版與間距問題。
- 修正管理首頁卡片佈局在特定分辨率下錯列（客服卡片不再佔滿三欄）。
- 修正 websocket 初始化偶發報錯（持續重連策略穩定）。

---

🏗️ INFRASTRUCTURE
- Nginx：
  - add_header Permissions-Policy "" always; 以去除不被支援的瀏覽器功能提示。
  - 強化 SPA 與 Socket.IO 反代設定備援超時與緩衝配置。

---

📚 升級步驟
1) 後端實作或確認以下端點（若已存在可略過）：
   - GET /api/admin/chat/rooms/{roomId}/members
   - POST /api/admin/chat/rooms/{roomId}/invite
   - DELETE /api/admin/chat/rooms/{roomId}/members/{userId}
   - DELETE /api/admin/chat/rooms/{roomId}
2) 重新建置並部署：
   - docker compose build backend frontend nginx && docker compose up -d
3) 重新載入 Nginx 以套用 Permissions-Policy 調整。
4) 清除前端快取（行動端建議強制重新載入），避免舊版 bundle 影響。

---

📸 Instagram 整體優化與修正

1) 渲染與模板
- IGRenderer：
  - 文字渲染流程統一：依是否含附件選擇 text_with_attachment / text_without_attachment；先將 Markdown/HTML 轉純文字，再渲染。
  - 回覆前綴：圖片內文支援回覆行（reply），可套用 caption_template.reply 或 post_id_format 模板，樣式支援 hashtag/plain。
  - 浮水印與 Logo 圖層順序明確，支援時間戳、格式化 ID 與自訂文字三類子項。
  - 預覽導引線：支援以環境變數 IG_PREVIEW_GUIDES=1 顯示對齊輔助線（僅預覽）。
  - 渲染輸出路徑可經 IG_RENDER_BASE_PATH 指定，便於與 CDN 共享。
- IGCaptionGenerator：
  - 單篇/輪播 caption 統一以 caption_template.structure 定義區塊（header/divider/content/post_id/footer/hashtags）。
  - 回覆前綴：支援 caption_template.reply，未配置時預設啟用並 fallback #<reply_id>。
  - 輪播 caption：自動計算固定區塊長度與每篇可用字數（保底 50 字），逐篇截斷，並支援每篇編號與 Post ID。
  - 嚴格長度限制：最終輸出截斷至 2200 字內。

2) 發布與 API
- IGPublisher：
  - 單篇/輪播完整流程：建立 container → 等待完成 → publish → 寫回 ig_media_id/permalink/status。
  - 輪播 unique 約束處理：僅第一筆寫入 ig_media_id，其餘保留 NULL，但全部寫回 permalink 與排序資訊。
  - 介接 IGAPIClient 時統一等待參數：IG_MAX_WAIT（預設 600s）、IG_RETRY_INTERVAL（預設 2s）。
  - 發布前媒體 URL 驗證（_validate_media_url），避免 CDN 無效連結造成 API 失敗。
- 檢查與工具：
  - check_ig_status.py：校驗 DB 與 IG 實際狀態差異，並提供自動修正（permalink/error_message）。
  - clear_and_test.py：清空與驗證流程工具，包含帳號統計重置與自動發佈測試。

3) 模型與相容
- 使用資料庫 IGTemplate 驅動所有渲染與 caption 配置，移除硬編碼預設值。
- 時區與時間戳：維持 UTC 儲存、前端顯示正確轉換，圖片/Caption 可由模板控制格式。

4) 組態與部署
- 重要環境變數：
  - IG_RENDER_BASE_PATH：渲染輸出根目錄（預設 /app/uploads/ig_rendered）。
  - IG_MAX_WAIT / IG_RETRY_INTERVAL：等待 container 完成的上限與輪詢間隔。
  - PUBLIC_CDN_URL / CDN 相關：確保渲染輸出可由 IG 端直連（必填）。
- Nginx 與 CDN：
  - /uploads 與前端預覽路徑一致，確保 IG 可取圖；路徑策略與快取頭已對齊。

5) 測試
- backend/tests/test_ig_renderer.py：
  - 驗證 caption 長度與 Post ID 格式化（含 #NCKU_POST_12345 等）。
  - 覆蓋單篇渲染與回覆前綴、輪播字數分配等核心路徑。


🔎 已知注意事項
- 若後端尚未提供統一聊天室治理端點，上述新功能會退化或不可用。
- 若行動端仍出現被底部 NavBar 遮擋，請清快取後再試；或回報實際裝置與路徑以便微調安全間距。

---

📅 最後更新：2025-10-10
🏢 開發團隊：Serelix Studio
📧 技術支援：透過平台內建支援系統

---
