# ForumKit V1.3.0 - Instagram 整合系統

## 版本概述

ForumKit V1.3.0 引入了完整的 Instagram 整合系統，實現了從 ForumKit 到 Instagram 的自動化內容發布功能。本版本專注於提供模組化、可營運、可測試的 Instagram 整合解決方案，支援多校帳號與後台管理。

## 主要功能

### 1. Instagram 整合系統

#### 1.1 發布規則
- **平台預設規則**：
  - 每 10 篇貼文自動發布到 Instagram
  - 或每 6 小時定時發布
  - 排他條件：若在 6 小時內因「10 篇觸發」已經發布，則取消定時觸發
- **各校可調整**：
  - 校方可自行設定「每 X 篇」或「每 Y 小時」
  - 系統提示超過 IG API 限額（50 則/24h）的警告

#### 1.2 權限與帳號管理
- **角色權限**：
  - `dev_admin`：設定平台全域 IG 預設頻率、管理「總平台 IG 帳號」
  - `campus_admin`：綁定自己學校的 IG 帳號、調整校內頻率、設定模板
  - 一般使用者：只能看到哪些貼文被同步至 IG
- **帳號類型**：
  - 總平台 IG（由 dev_admin 綁定，處理跨校貼文）
  - 校園 IG（由 campus_admin 綁定，處理校內貼文）

#### 1.3 模板功能
- **貼文文字**：字體、大小、位置自訂
- **校徽**：位置、大小可調整
- **背景**：純色或背景圖疊白色方塊（顏色、透明度、大小、圓角可調）
- **配色方案**：標題、說明、背景全局色系
- **時間戳**：格式（YYYY/MM/DD、24H、AM-PM）、大小、位置
- **Caption 模板**：支援參數（校名、文章標題、作者代碼等）

#### 1.4 使用流程
1. 使用者在 ForumKit 發新貼文
2. 系統計算是否達發布條件（10 篇或 6 小時）
3. 若觸發 → 產生 IG Post
   - 套用模板（文字/校徽/背景/時間戳）
   - 生成 caption
   - 上傳 IG Media Container → Publish
4. 結果存入資料庫，顯示在後台「IG 發布紀錄」

### 2. 後台管理介面

#### 2.1 管理後台快捷卡片
- 移除「管理員聊天室」快捷圖卡
- 新增「IG 整合管理」快捷圖卡
- 新增「刪文請求」快捷圖卡，顯示待審數量和今日處理數量

#### 2.2 Instagram 管理頁面
- **帳號管理**：查看、新增、編輯 Instagram 帳號
- **發布記錄**：查看所有發布記錄，支援重試失敗的發布
- **統計資料**：總帳號數、今日發布、本月發布、失敗發布數
- **操作工具**：自動發布檢查、權杖管理

### 3. 通知系統改進

#### 3.1 通知中心重新設計
- 通知數量反映實際未讀通知數，而非固定「1」
- 新通知顯示數字 10 秒後變為紅點
- 點開或標記已讀後不再顯示數字
- 修正 NavBar 通知數字的黑底黑字問題，配合主題系統

#### 3.2 管理後台統計改進
- 修正「今日已處理」數字，基於審核紀錄計算
- 新增刪文請求統計區塊
- 顯示待審請求、今日處理、今日核准、今日拒絕數量

## 技術實現

### 1. 後端架構

#### 1.1 資料庫模型
```python
# 新增 Instagram 相關模型
- InstagramAccount: Instagram 帳號表
- InstagramSetting: Instagram 發布設定表
- InstagramTemplate: Instagram 模板表
- InstagramPost: Instagram 發布記錄表
- InstagramEvent: Instagram 事件記錄表
```

#### 1.2 API 端點
```python
# 前台 API
GET /api/ig/settings - 讀取校內設定
POST /api/ig/settings - 修改校內 IG 設定
POST /api/ig/templates - 新增或更新模板
GET /api/ig/templates/<account_id> - 獲取模板
GET /api/ig/posts/<account_id> - 獲取發布記錄
POST /api/ig/posts/<post_id>/publish - 手動發布
POST /api/ig/posts/<post_id>/retry - 重試發布

# 管理後台 API
GET /api/admin/instagram/accounts - 獲取所有帳號
POST /api/admin/instagram/accounts - 創建帳號
PATCH /api/admin/instagram/accounts/<id> - 更新帳號
POST /api/admin/instagram/accounts/<id>/refresh-token - 刷新權杖
GET /api/admin/instagram/posts - 獲取所有發布記錄
GET /api/admin/instagram/stats - 獲取統計資料
POST /api/admin/instagram/auto-publish - 觸發自動發布
```

#### 1.3 服務層
```python
# InstagramService 核心業務邏輯
- create_account: 創建 Instagram 帳號
- get_account_token: 獲取並解密存取權杖
- refresh_token: 刷新長期存取權杖
- check_publishing_conditions: 檢查發布條件
- generate_instagram_image: 生成 Instagram 圖片
- create_instagram_post: 創建 Instagram 發布任務
- publish_to_instagram: 發布到 Instagram
- log_event: 記錄事件
```

### 2. 前端架構

#### 2.1 管理後台頁面
```typescript
// InstagramManagement.tsx
- 帳號管理：卡片式顯示，支援新增、編輯、刷新權杖
- 發布記錄：表格顯示，支援重試、查看圖片
- 統計資料：卡片式統計，總帳號數、發布數量等
- 操作工具：自動發布檢查、權杖管理
```

#### 2.2 通知系統改進
```typescript
// useNotifications.ts
- 新增 showCount 和 lastNotificationTime 狀態
- 實現 10 秒數字顯示後變為紅點的邏輯
- 點擊或標記已讀後隱藏數字

// NotificationButton.tsx
- 條件渲染數字徽章或紅點
- 配合主題系統的顏色設定
```

### 3. 安全性

#### 3.1 權杖管理
- 存取權杖加密儲存
- 每日自動刷新長期存取權杖
- 權杖到期檢查和提醒

#### 3.2 權限控制
- 所有 API 端點需要 JWT 認證
- 角色基礎的權限控制（dev_admin, campus_admin）
- campus_admin 只能管理自己學校的帳號

#### 3.3 配額管理
- 發文配額檢查，避免超過 IG API 限制（50/24h）
- 所有動作寫入 ig_events 表（審計）

## 檔案結構

### 新增檔案
```
backend/
├── models/instagram.py              # Instagram 資料模型
├── services/instagram_service.py    # Instagram 業務邏輯
├── routes/routes_instagram.py       # 前台 Instagram API
└── routes/routes_admin_instagram.py # 管理後台 Instagram API

frontend/src/
├── pages/admin/InstagramManagement.tsx  # Instagram 管理頁面
└── components/notifications/NotificationCount.tsx  # 通知數量組件

docs/
├── ADMIN_DASHBOARD_UPDATE.md        # 管理後台更新文檔
└── NOTIFICATION_SYSTEM_REDESIGN.md  # 通知系統重新設計文檔

scripts/
├── test_admin_dashboard.sh          # 管理後台測試腳本
└── test_notification_system.sh      # 通知系統測試腳本
```

### 修改檔案
```
backend/
├── models/school.py                 # 新增 Instagram 關聯
├── models/__init__.py               # 導入 Instagram 模型
└── app.py                          # 註冊 Instagram 路由

frontend/src/
├── pages/AdminDashboard.tsx         # 新增 IG 整合管理卡片
├── pages/admin/ModerationPage.tsx   # 新增刪文請求統計
├── hooks/useNotifications.ts        # 通知系統邏輯改進
├── components/notifications/NotificationButton.tsx  # 通知按鈕改進
└── utils/App.tsx                    # 新增 Instagram 管理路由
```

## 部署注意事項

### 1. 環境變數
```bash
# Instagram 整合相關
FACEBOOK_APP_ID=your_facebook_app_id
FACEBOOK_APP_SECRET=your_facebook_app_secret
```

### 2. 依賴套件
```python
# 新增 Python 依賴
Pillow>=10.0.0  # 圖片處理
requests>=2.31.0  # HTTP 請求
```

### 3. 資料庫遷移
```bash
# 需要執行 Alembic 遷移來創建新的 Instagram 相關表格
alembic revision --autogenerate -m "Add Instagram integration tables"
alembic upgrade head
```

## 測試

### 1. 功能測試
```bash
# 測試管理後台功能
./scripts/test_admin_dashboard.sh

# 測試通知系統
./scripts/test_notification_system.sh
```

### 2. API 測試
```bash
# 測試 Instagram API 端點
curl -X GET "https://forum.serelix.xyz/api/admin/instagram/accounts" \
  -H "Authorization: Bearer YOUR_TOKEN"

curl -X GET "https://forum.serelix.xyz/api/admin/instagram/stats" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 已知問題與限制

### 1. 當前限制
- Instagram Graph API 每日發布限制為 50 則
- 需要 Facebook 應用程式和 Instagram 商業帳號
- 權杖需要定期刷新（60 天）

### 2. 待實現功能
- Celery/RQ 背景任務處理
- 自動權杖刷新排程
- 模板編輯器的拖拽式 UI
- 圖片預覽功能

---

*📅 最後更新：2025-08-31*
*🏢 開發團隊：Serelix Studio*
*📧 技術支援：透過平台內建支援系統*

---