# 🎫 ForumKit V1.2.0 工單系統部署指南

> **重大更新：從簡單回報系統升級為完整工單管理系統**

## 📋 更新概要

V1.2.0 版本將原本的簡單支援回報系統完全重新設計為企業級工單管理系統，提供：

- ✅ 完整工單生命週期管理
- ✅ 智慧追蹤碼系統  
- ✅ 手機優先的用戶界面
- ✅ 管理員分級權限
- ✅ 豐富的歷史記錄

---

## 🗄️ 數據庫遷移

### 新增表格
此次更新將創建以下新表格：

```sql
-- 工單主表
support_tickets
-- 工單回覆表  
ticket_responses
-- 工單附件表
ticket_attachments
-- 工單歷史表
ticket_history
-- 用戶識別碼表
user_identity_codes
```

### 執行遷移

```bash
# 在 Docker 環境中執行
docker-compose exec backend alembic upgrade head

# 或者在開發環境中
cd backend
python -m alembic upgrade head
```

---

## 🔧 部署步驟

### 1. 備份現有數據（重要！）

```bash
# 備份數據庫
docker-compose exec postgres pg_dump -U forumkit forumkit > forumkit_backup_$(date +%Y%m%d).sql

# 備份上傳文件
cp -r uploads uploads_backup_$(date +%Y%m%d)
```

### 2. 拉取最新代碼

```bash
git pull origin main
# 確保您在 V1.1.6 版本
git checkout v1.1.6
```

### 3. 重建應用

```bash
# 停止服務
docker-compose down

# 重建並啟動
docker-compose up --build -d

# 檢查服務狀態
docker-compose ps
```

### 4. 執行數據庫遷移

```bash
# 等待數據庫完全啟動
sleep 10

# 執行遷移
docker-compose exec backend alembic upgrade head
```

### 5. 驗證部署

```bash
# 檢查健康狀態
curl http://localhost:12005/api/healthz

# 檢查工單系統API
curl http://localhost:12005/api/support/recent
```

---

## 📱 新功能說明

### 用戶端功能

#### 1. 工單提交
- **路徑**: `/support`
- **功能**: 提交新工單，支援圖片附件
- **追蹤**: 自動生成追蹤碼

#### 2. 工單追蹤  
- **路徑**: `/track`
- **功能**: 使用追蹤碼查詢工單狀態
- **支援**: 匿名用戶和已登入用戶

#### 3. 手機版支援
- **路徑**: `/mobile-support`
- **功能**: 三合一介面（提交/追蹤/歷史）
- **優化**: 觸控友好，響應式設計

### 管理員功能

#### 1. 工單管理
- **路徑**: `/admin/support-inbox` 
- **權限**: 根據管理員角色過濾工單
- **功能**: 查看、回覆、指派工單

#### 2. API端點
```
GET  /api/support/recent     # 獲取最新工單
GET  /api/support/my         # 我的工單歷史
POST /api/support/reply      # 管理員回覆
GET  /api/support/track/:code # 追蹤工單
```

---

## 🔐 權限設置

### 管理員角色說明

| 角色 | 可處理工單範圍 |
|------|----------------|
| `dev_admin` | 所有工單 |
| `cross_admin` | 跨校工單 |
| `campus_admin` | 所屬學校的校內工單 |

### 權限驗證
- 用戶只能查看自己提交的工單
- 管理員根據角色限制可處理的工單範圍
- 匿名用戶需要追蹤碼才能查看工單

---

## 🎨 界面集成

### 導航更新
需要更新導航菜單以包含新的工單功能：

```typescript
// 在導航組件中添加
{
  name: '客服支援',
  href: '/support',
  icon: MessageSquare
}
```

### 路由配置
確保以下路由正確配置：

```typescript
// React Router 路由
{
  path: '/support',
  element: <SupportPage />
},
{
  path: '/track',
  element: <TicketTrackPage />  
},
{
  path: '/mobile-support',
  element: <MobileSupportPage />
}
```

---

## 🐛 故障排除

### 常見問題

#### 1. 遷移失敗
```bash
# 檢查數據庫連接
docker-compose logs postgres

# 手動執行遷移
docker-compose exec backend alembic current
docker-compose exec backend alembic upgrade head
```

#### 2. 工單號生成錯誤
```bash
# 檢查工單號生成函數
docker-compose exec backend python -c "from utils.ticket import new_ticket_id; print(new_ticket_id())"
```

#### 3. 權限問題
```bash
# 檢查用戶角色
docker-compose exec backend python -c "
from utils.db import get_session
from models import User
with get_session() as s:
    users = s.query(User).filter(User.role.in_(['dev_admin', 'cross_admin', 'campus_admin'])).all()
    for u in users: print(f'{u.username}: {u.role}')
"
```

### 日志查看
```bash
# 後端日志
docker-compose logs backend -f

# 數據庫日志  
docker-compose logs postgres -f
```

---

## 📊 監控和維護

### 健康檢查
```bash
# API 健康檢查
curl http://localhost:12005/api/healthz

# 工單系統狀態
curl http://localhost:12005/api/support/recent \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

### 數據庫維護
```bash
# 查看工單統計
docker-compose exec postgres psql -U forumkit -d forumkit -c "
SELECT status, COUNT(*) FROM support_tickets GROUP BY status;
"

# 查看最近的工單
docker-compose exec postgres psql -U forumkit -d forumkit -c "
SELECT ticket_number, subject, status, created_at 
FROM support_tickets 
ORDER BY created_at DESC LIMIT 10;
"
```

---

## 🚀 性能優化建議

### 數據庫索引
遷移已自動創建必要索引，包括：
- `idx_tickets_status_created` - 狀態和創建時間
- `idx_tickets_number` - 工單號碼唯一索引
- `idx_responses_ticket_created` - 回覆時間索引

### 緩存策略
考慮為頻繁查詢添加 Redis 緩存：
- 最近工單列表
- 用戶工單統計
- 狀態分布統計

---

## 📞 技術支援

如果在部署過程中遇到問題：

1. **檢查日志**: `docker-compose logs backend`
2. **驗證數據庫**: 確保所有新表格已創建
3. **測試API**: 使用 curl 或 Postman 測試端點
4. **檢查權限**: 確認管理員用戶角色正確設置

---

*📅 最後更新：2025-08-28*
*🏢 開發團隊：Serelix Studio*
*📧 技術支援：透過平台內建支援系統*

---
