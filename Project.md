---

# ForumKit 專案文檔

## 專案簡介

**ForumKit** 是一個針對校園環境設計的匿名討論平台，具備全匿名及半匿名模式，提供用戶匿名發文、留言、媒體上傳等功能，並且支持即時互動。後台管理系統包括文章審核、用戶管理與公告管理，平台支持與 Discord 和 Instagram 進行社群整合，進行全方位的互動。

---

## 技術棧

* **前端**：

  * **React**：構建單頁應用（SPA）
  * **TypeScript**：增強 JavaScript 的可維護性和穩定性
  * **Tailwind CSS**：快速構建響應式 UI
  * **Vite**：開發和構建工具

* **後端**：

  * **Flask**：Python 微框架，提供 RESTful API
  * **Socket.IO**：即時通訊功能，支持 WebSocket
  * **Flask-JWT-Extended**：JSON Web Token 認證
  * **SQLAlchemy**：ORM，處理資料庫操作

* **資料庫**：

  * **PostgreSQL**：關聯式資料庫，存儲用戶、文章、評論等數據
  * **Redis**：快取和即時訊息（Pub/Sub）

* **部署**：

  * **Docker**：容器化部署
  * **Nginx**：反向代理，靜態檔案提供

* **工具**：

  * **Git**：版本控制
  * **CI/CD**：自動化部署流程
  * **Cloudflare**：DNS 和 Web 優化

---

## 專案目標

* **匿名討論平台**：提供校園內部與外部用戶討論的平台，支持匿名與半匿名功能。
* **七層角色權限管理**：不同權限的用戶可以訪問不同的功能與頁面。
* **社群整合**：支援 Discord 與 Instagram 整合，增加平台的交互性。
* **高效的文章與媒體審核機制**：提供後台管理系統，支持文章和媒體的審核流程。
* **即時互動**：支持即時消息推送與 WebSocket 連接，實現文章評論和即時聊天功能。

---

## 架構設計

### 1. 前端架構

前端部分使用 React + TypeScript + Tailwind CSS 建立單頁應用，實現響應式網頁設計，支援桌面、手機版顯示。主要包含以下功能：

* 登入/註冊系統
* 文章發表與瀏覽
* 留言與即時互動
* 校內/校外模式切換
* 使用者角色管理與權限控制
* 公告與活動展示

### 2. 後端架構

後端使用 Flask 提供 RESTful API，與前端進行資料交互。設計包括以下功能：

* 用戶認證（JWT）
* 文章與留言管理
* 審核系統（管理員可審核發文/媒體）
* 社群整合（Discord、Instagram）
* WebSocket 連接實現即時互動

### 3. 資料庫架構

使用 PostgreSQL 存儲平台的所有資料，包括用戶資料、發文、留言等，資料表設計包含：

* **users**：用戶資訊（帳號、密碼、角色等）
* **posts**：文章資料（標題、內容、狀態等）
* **comments**：留言資料（用戶ID、內容、所屬文章等）
* **media**：媒體資料（圖片、影片等）
* **schools**：學校資料（用於區分校內外域）
* **logs**：操作日誌（管理員審核等）

### 4. 系統架構圖

```mermaid
graph LR
    A[User] -->|JWT| B[Frontend (React)]
    B --> C[Backend (Flask)]
    C --> D[PostgreSQL]
    C --> E[Redis]
    C --> F[Socket.IO]
    E --> G[CDN]
    F --> H[Discord/IG]
```

---

## 開發進度

### Day 1 — 專案規劃與基礎架構搭建

* 建立專案目錄結構與基本設定
* 設置 Git 版本控制，並推送至 GitHub

### Day 2 — 前端架構設計

* 完成 React + TypeScript 環境搭建
* 使用 Tailwind CSS 完成基本頁面布局
* 配置 Vite，啟動開發伺服器

### Day 3 — 後端架構設計

* 搭建 Flask 基本架構，配置 CORS
* 設計基本的 RESTful API 路由
* 設置 PostgreSQL 資料庫與 SQLAlchemy ORM

### Day 4 — 用戶認證與 JWT

* 完成用戶註冊、登入 API
* 使用 JWT 進行身份驗證
* 配置用戶角色與權限管理

### Day 5 — 發文與留言功能

* 完成發文與留言的 API 設計
* 前端實現發文、留言顯示功能
* 支援圖片與影片的附件上傳

### Day 6 — 審核系統實作

* 完成文章與媒體的審核流程
* 管理員可以審核、駁回發文/留言/媒體
* 後台管理界面設計

### Day 7 — 即時互動功能

* 配置 WebSocket 與 Socket.IO，實現即時推播
* 前端顯示即時留言與文章更新

### Day 8 — 社群整合（Discord/Instagram）

* 實現 Discord Webhook 通知
* 完成 Instagram 整合，支持發布到 Instagram

### Day 9 — CDN 與 Port 更新

* 新建 CDN 容器，掛載 `uploads/public`
* 確保所有服務端口正確配置：12002、12005、12007、12008

## Day 10 — 即時互動功能強化

### 🎯 目標

* **優化 WebSocket 連接**：確保即時消息推播功能不會斷線或丟失消息。
* **多房間支持**：實現聊天室功能，可以根據不同文章或主題動態創建聊天室，實現多人即時互動。
* **用戶狀態管理**：確保 WebSocket 連線的用戶狀態（在線/離線）能夠被正確追蹤並顯示。

### 🔧 開發步驟

1. **擴展 WebSocket 事件**

   * 在後端 Socket.IO 服務中，為每個文章創建獨立的房間（聊天室）。
   * 用戶進入房間後，能夠即時接收到該文章的所有留言與回應。

2. **前端即時消息優化**

   * 在 React 中，使用 `useEffect` 訂閱 WebSocket 消息，當有新消息或新留言時，自動更新 UI。
   * 加入離線提醒，當用戶進入聊天室後，能夠看到離線用戶發送的消息。

3. **連線監控**

   * 加入 WebSocket 連線檢測與錯誤處理邏輯，確保連線斷開時能夠自動重連。

4. **測試**

   * 測試多用戶在同一房間的實時互動情況，確保消息不會延遲或丟失。

### 💡 成果

* 用戶可在同一文章頁面即時互動
* 前端能自動接收並顯示後端推送的消息
* WebSocket 連線錯誤能夠自動重連

---

## Day 11 — 媒體安全與優化

### 🎯 目標

* **導入 ClamAV 扫描容器**：對上傳的媒體進行病毒掃描，保證平台安全。
* **自動縮圖處理**：對上傳的圖片進行縮圖處理，減少存儲空間並提升載入速度。

### 🔧 開發步驟

1. **集成 ClamAV 扫描**

   * 使用 Docker 部署 ClamAV 容器，並在後端進行文件上傳時，將上傳的媒體交由 ClamAV 進行掃描。
   * 任何掃描結果為「可疑」的文件應該直接拒絕上傳並顯示警告。

2. **自動縮圖處理**

   * 使用 Python 的 `Pillow` 函式庫，對圖片進行大小處理，生成縮圖文件。
   * 儲存縮圖至 CDN，並在前端顯示圖片的縮略圖版本，保證頁面載入速度。

3. **測試**

   * 測試不同格式的媒體文件（圖片、影片）上傳，確認 ClamAV 能正確掃描並拒絕含有病毒的文件。
   * 確認圖片縮圖處理正確，並能在前端頁面上顯示。

### 💡 成果

* 每次上傳的媒體會經過病毒掃描，提升平台安全性
* 所有圖片都會自動進行縮圖，提升用戶體驗

---

## Day 12 — 後台完整管理系統

### 🎯 目標

* **用戶管理功能**：提供管理員可管理用戶帳號，包括禁用/刪除帳號。
* **文章審核**：完成管理員對文章與留言的審核功能，並能查看歷史審核紀錄。
* **報告與統計**：提供簡單的使用報告，統計文章數量、用戶活躍度等。

### 🔧 開發步驟

1. **用戶管理頁面**

   * 管理員可以查看所有用戶資料，包括用戶ID、註冊時間、帳號狀態等，並可進行禁用或刪除操作。

2. **文章與留言審核**

   * 管理員可以查看待審核的文章和留言，支持審核通過或駁回，並能夠查看每一篇文章/留言的審核歷史紀錄。

3. **報告系統**

   * 實現基本的報告頁面，顯示活躍用戶數、發布的文章數量等指標。

4. **測試**

   * 測試管理員是否能正確管理用戶帳號，並且是否能準確審核文章與留言。

### 💡 成果

* 管理員能夠有效管理用戶與內容
* 提供基礎的報告與統計，幫助平台運營

---

## Day 13 — 即時客服聊天與用戶支援

### 🎯 目標

* **即時客服聊天**：實現管理員與用戶之間的即時消息交互。
* **自動回覆機制**：為常見問題設定自動回覆。

### 🔧 開發步驟

1. **即時客服功能**

   * 使用 WebSocket 實現管理員與用戶的雙向即時聊天。
   * 在後端實現一個簡單的「客服」房間，管理員可以與用戶進行一對一聊天。

2. **自動回覆**

   * 配置一個簡單的關鍵字識別系統，對一些常見問題進行自動回覆。

3. **測試**

   * 測試客服是否能在即時聊天中快速響應用戶提問，並確認自動回覆機制是否運作正常。

### 💡 成果

* 用戶能夠通過即時聊天與管理員進行互動
* 常見問題得到自動回覆，減少客服負擔

---

## Day 14 — 部署優化與 HTTPS 配置

### 🎯 目標

* **部署優化**：優化容器部署流程，縮短啟動時間並減少錯誤。
* **HTTPS 配置**：將平台切換到 HTTPS，保證數據傳輸安全。

### 🔧 開發步驟

1. **優化 Docker 部署**

   * 減少 Docker 容器啟動時間，提升整體部署效率。
   * 配置健康檢查，確保服務正常運行。

2. **HTTPS 配置**

   * 使用 Let's Encrypt 配置免費的 SSL 證書，將所有流量切換至 HTTPS。
   * 配置 Nginx 支援 SSL 並強制跳轉 HTTP 至 HTTPS。

3. **測試**

   * 測試 HTTPS 是否正確生效，並確保所有頁面在 HTTPS 下可以正常載入。
   * 測試部署後，是否能夠快速啟動並正常運行。

### 💡 成果

* 所有數據傳輸均使用 HTTPS，加強平台的安全性
* 部署流程優化，啟動時間縮短

---

## 開發與部署步驟

### 1. 專案克隆與設定

```bash
git clone https://github.com/yourusername/forumkit.git
cd forumkit
```

### 2. 安裝依賴

```bash
# 安裝前端依賴
cd frontend
npm install

# 安裝後端依賴
cd backend
pip install -r requirements.txt
```

### 3. 建立資料庫與遷移

```bash
# 在 backend 目錄下執行
flask db upgrade
```

### 4. 運行服務

```bash
docker-compose up --build
```

### 5. 測試與驗證

```bash
# 測試 API 是否正常
curl http://localhost:12005/api/healthz
```

---

## 常見錯誤排查

1. **API 路由 404**

   * 檢查是否在後端正確註冊路由
   * 確保 Nginx 配置正確反向代理

2. **WebSocket 連接失敗**

   * 檢查 Nginx 配置是否正確處理 WebSocket
   * 檢查 `socket.io` 版本是否匹配

3. **靜態檔案無法載入**

   * 檢查 CDN 容器的掛載目錄是否正確
   * 確保 `uploads/public` 目錄權限設置為可讀

---