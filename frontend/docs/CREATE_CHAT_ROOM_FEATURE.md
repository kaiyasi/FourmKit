# 建立聊天室功能

## 功能概述

新的建立聊天室功能允許管理員（dev_admin 和 campus_admin）創建自定義聊天室，並邀請指定對象或權限組進入。

## 功能特點

### 1. 權限控制
- **dev_admin**: 可以創建任何類型的聊天室，可以邀請任何用戶
- **campus_admin**: 只能創建自己學校的聊天室，只能邀請自己學校的用戶

### 2. 聊天室類型
- **公開聊天室**: 所有有權限的用戶都可以看到
- **私密聊天室**: 只有被邀請的用戶才能看到

### 3. 邀請方式
- **角色組邀請**: 邀請特定角色的所有用戶（如所有校內管理員）
- **指定用戶邀請**: 邀請特定的單個用戶
- **學校邀請**: 邀請特定學校的所有管理員和版主

## 使用流程

### 1. 進入建立頁面
1. 在聊天室列表頁面點擊"建立聊天室"按鈕
2. 系統會導航到 `/admin/chat/create` 頁面

### 2. 填寫基本資訊
- **聊天室名稱**（必填）: 最多50個字符
- **描述**（可選）: 最多200個字符
- **聊天室類型**: 選擇公開或私密

### 3. 添加邀請
1. 點擊"添加邀請"按鈕
2. 選擇邀請類型：
   - **角色組**: 選擇要邀請的角色（開發管理員、校內管理員等）
   - **指定用戶**: 搜尋並選擇特定用戶
   - **學校**: 選擇要邀請的學校（會邀請該校所有管理員和版主）
3. 點擊目標對象完成添加
4. 可以重複添加多個邀請

### 4. 創建聊天室
1. 確認所有資訊正確
2. 點擊"創建聊天室"按鈕
3. 系統會創建聊天室並自動邀請指定用戶

## 技術實現

### 前端文件
- `frontend/src/pages/admin/CreateChatRoomPage.tsx`: 建立聊天室頁面
- `frontend/src/pages/admin/ChatPage.tsx`: 修改了聊天室列表頁面，添加建立按鈕

### 後端 API
- `POST /api/admin/chat-rooms/create`: 創建新的聊天室
- `GET /api/admin/chat-rooms`: 修改了聊天室列表 API，支持顯示自定義聊天室

### 數據庫模型
- `ChatRoom`: 聊天室模型，新增了自定義聊天室支持

## API 文檔

### 創建聊天室 API

**端點**: `POST /api/admin/chat-rooms/create`

**權限**: dev_admin, campus_admin

**請求體**:
```json
{
  "name": "聊天室名稱",
  "description": "聊天室描述",
  "room_type": "public|private",
  "invite_targets": [
    {
      "type": "role|user|school",
      "id": "目標ID",
      "name": "顯示名稱",
      "description": "描述"
    }
  ]
}
```

**響應**:
```json
{
  "ok": true,
  "room": {
    "id": "custom:abc12345",
    "name": "聊天室名稱",
    "description": "聊天室描述",
    "room_type": "custom",
    "owner_id": 123,
    "school_id": 456,
    "invited_users": [1, 2, 3]
  }
}
```

## 權限規則

### 創建權限
- **dev_admin**: 可以創建任何聊天室
- **campus_admin**: 只能創建自己學校的聊天室

### 訪問權限
- **dev_admin**: 可以訪問所有自定義聊天室
- **campus_admin**: 只能訪問自己創建的聊天室或自己學校的聊天室

### 邀請權限
- **dev_admin**: 可以邀請任何用戶
- **campus_admin**: 只能邀請自己學校的用戶

## 注意事項

1. 聊天室名稱必須唯一
2. 自定義聊天室會自動分配以 `custom:` 開頭的 ID
3. 邀請的用戶會自動獲得訪問權限
4. 聊天室創建後會立即出現在聊天室列表中
5. 只有聊天室創建者和管理員可以刪除聊天室

## 界面改進

### 聊天室管理界面
- **設定選單**: 將加入成員、移除成員、刪除聊天室等功能整合到設定選單中
- **並排佈局**: 線上用戶顯示與設定選單並排顯示，節省空間
- **下拉選單**: 使用下拉選單替代多個按鈕，界面更簡潔
- **點擊外部關閉**: 點擊設定選單外部區域自動關閉選單

### 權限組邀請
- 支持邀請特定角色組的所有用戶
- 支持邀請特定學校的所有管理員和版主
- 支持邀請指定的單個用戶

## 事件記錄系統

### 聊天室操作事件記錄
所有聊天室相關操作都會自動記錄到系統事件日誌中：

- **聊天室創建**: 記錄創建者、聊天室信息、邀請目標等
- **聊天室刪除**: 記錄刪除者、被刪除的聊天室信息
- **成員添加**: 記錄添加者、被添加的用戶、聊天室信息
- **成員移除**: 記錄移除者、被移除的用戶、聊天室信息

### 事件記錄內容
每個事件記錄包含：
- 操作者信息（用戶ID、用戶名、角色）
- 目標對象信息（聊天室ID、名稱、描述等）
- 操作時間和客戶端信息
- 詳細的操作描述和元數據
- 嚴重程度分級（low, medium, high, critical）

### 事件查看
管理員可以在事件記錄頁面查看所有聊天室相關操作：
- 按事件類型過濾（chat.room.*）
- 按嚴重程度過濾
- 按時間範圍查看
- 支持搜索和統計

## 數據庫模型

### ChatRoomMember 模型
新增了 `ChatRoomMember` 模型來持久化聊天室成員關係：
- `room_id`: 聊天室ID
- `user_id`: 用戶ID
- `joined_at`: 加入時間
- `is_active`: 是否為活躍成員

## 未來改進

1. 支持聊天室權限設置
2. 添加聊天室統計功能
3. 支持聊天室分類和標籤
4. 添加聊天室搜索功能
5. 支持聊天室公告功能
6. 添加聊天室檔案分享功能
7. 支持聊天室消息審核
8. 添加聊天室活動日誌
