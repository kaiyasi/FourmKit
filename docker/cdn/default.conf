server {
  listen 80;
  server_name _;

  # Serve from mounted volume
  root /usr/share/nginx/html;
  autoindex off;
  index index.html;

  # Security headers
  add_header X-Content-Type-Options nosniff always;
  add_header X-Frame-Options DENY always;
  add_header Referrer-Policy no-referrer always;
  add_header Content-Security-Policy "default-src 'none'; img-src 'self' data: blob: https:; media-src 'self' https:;" always;

  # Cache policy: allow browsers/CDN to cache media moderately
  location / {
    # 使用預設 mime.types，讓圖片/影片有正確 Content-Type
    try_files $uri =404;
    # Basic caching for public media
    add_header Cache-Control "public, max-age=604800, immutable";
  }

  # Fallback: if client requests wrong extension for numeric id, try common alternatives
  location ~* ^/media/([0-9]+)\.(png|jpg|jpeg|webp|gif|mp4|webm)$ {
    try_files $uri \
              /media/$1.jpg \
              /media/$1.jpeg \
              /media/$1.webp \
              /media/$1.png \
              /media/$1.gif \
              /media/$1.mp4 \
              /media/$1.webm =404;
    add_header Cache-Control "public, max-age=604800, immutable";
  }

  # Fallback: if files exist at root as <id>.<ext>, serve them and also map to /media/
  location ~* ^/([0-9]+)\.(png|jpg|jpeg|webp|gif|mp4|webm)$ {
    try_files $uri \
              /media/$1.jpg \
              /media/$1.jpeg \
              /media/$1.webp \
              /media/$1.png \
              /media/$1.gif \
              /media/$1.mp4 \
              /media/$1.webm =404;
    add_header Cache-Control "public, max-age=604800, immutable";
  }

  # Block dangerous extensions explicitly
  location ~* \.(php|sh|py|pl|cgi|exe|bat|cmd|ps1)$ {
    return 403;
  }
}
